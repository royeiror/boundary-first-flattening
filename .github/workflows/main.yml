name: Windows Build - BFF v1.6 (GUI)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag or branch to build (default v1.6)'
        required: false
        default: 'v1.6'

jobs:
  build-win:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.tag }}

      - name: Setup MSVC & msbuild
        uses: microsoft/setup-msbuild@v1

      - name: Install CMake
        uses: actions/setup-cmake@v3
        with:
          cmake-version: '3.26.4'

      - name: Configure (Release, enable GUI)
        shell: pwsh
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 -DBUILD_BFF_APPLICATION=ON -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release -- /m:4

      - name: Package executables
        shell: pwsh
        run: |
          $buildDir = Join-Path $PWD 'build'
          $outDir = Join-Path $PWD 'package'
          if (Test-Path $outDir) { Remove-Item $outDir -Recurse -Force }
          New-Item -ItemType Directory -Path $outDir | Out-Null

          # copy executables
          Get-ChildItem -Path $buildDir -Filter "*.exe" -Recurse | ForEach-Object {
            Copy-Item $_.FullName $outDir -Force
          }

          # copy DLL dependencies
          Get-ChildItem -Path $buildDir -Filter "*.dll" -Recurse | ForEach-Object {
            Copy-Item $_.FullName $outDir -Force
          }

          # copy any data directories (GUI resources)
          foreach ($d in @("apps", "shaders", "data", "textures")) {
            if (Test-Path (Join-Path $PWD $d)) {
              Copy-Item (Join-Path $PWD $d) (Join-Path $outDir $d) -Recurse -Force
            }
          }

          Write-Host "Packaged contents:"
          Get-ChildItem $outDir -Recurse

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bff-windows-v1.6
          path: build/package/**
          retention-days: 7
